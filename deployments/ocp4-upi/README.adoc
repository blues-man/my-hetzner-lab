# OpenShift 4 UPI installation on libvirt
ifdef::env-github[]
:imagesdir:
 https://gist.githubusercontent.com/path/to/gist/revision/dir/with/all/images
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
ifndef::env-github[]
:imagesdir: ./
endif::[]
:toc:
:toc-placement!:

CAUTION: This is a stupid bunch of informations for my self

toc::[]


## Links to various documentations
* https://libvirt.org/formatnetwork.html[Libvirt Network XML doc]
* https://libvirt.org/formatdomain.html[Libvirt Domain XML doc]
* https://docs.openshift.com/container-platform/4.1/installing/installing_bare_metal/installing-bare-metal.html[OpenShift 4.1 docs]
* https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.1/4.1.0-rc.3/[OpenShift 4.1 resources]
* https://openshift-release-artifacts.svc.ci.openshift.org/4.1.0-rc.3/[OpenShift 4.1 Installer and Client] 
* https://kcli.readthedocs.io/[KCLI Docs]
* https://github.com/coreos/coreos-installer[Upstream Installer]
* http://post-office.corp.redhat.com/archives/openshiftbeta/2019-May/msg00000.html[Red Hat Enterprise Linux CoreOS Eval Guide.pdf (Attachment)]



## PXE Example - not testet yet
----

[root@master Q-openstack]# cat ocp4-1.cfg 
PROMPT 0
TIMEOUT 100
SERIAL 0 115200

SAY ocp4-nvme kickstart install
SAY .
SAY DEFAULT is ocp4-http
DEFAULT ocp4-http

LABEL ocp4-http
   SAY ocp4-http:  Boot to ocp4 method using http
   KERNEL http://repo/repo/ocp4/rhcos-410.8.20190425.1-installer-kernel
   APPEND ip=dhcp rd.neednet=1 initrd=http://repo/repo/ocp4/rhcos-410.8.20190425.1-installer-initramfs.img console=ttyS0,115200n8 inst.sshd=1 coreos.inst=yes coreos.inst.install_dev=nvme1n1 coreos.inst.image_url=http://repo/repo/ocp4/rhcos-410.8.20190425.1-metal-bios.raw coreos.inst.ignition_url=http://repo/repo/ocp4/boostrap.ign
----

Source: https://coreos.slack.com/archives/C999USB0D/p1556627876298900

## Enviroment
### DNS
----
api-int.ocp4-upi.bohne.io	A	95.217.39.205
api.ocp4-upi.bohne.io	A	95.217.39.205
*.apps.ocp4-upi.bohne.io	A	95.217.39.205
etcd-0.ocp4-upi.bohne.io	A	10.84.3.30
etcd-1.ocp4-upi.bohne.io	A	10.84.3.31
etcd-2.ocp4-upi.bohne.io	A	10.84.3.32
_etcd-server-ssl._tcp.ocp4-upi.bohne.io	SRV	10\t2380\tetcd-0.ocp4-upi.bohne.io
_etcd-server-ssl._tcp.ocp4-upi.bohne.io	SRV	10\t2380\tetcd-1.ocp4-upi.bohne.io
_etcd-server-ssl._tcp.ocp4-upi.bohne.io	SRV	10\t2380\tetcd-2.ocp4-upi.bohne.io
---- 

image::ocp4-upi-dns.png[DNS Records]

### Haproxy

[source,config]
----
# OCP4 UPI
frontend ocp4-upi-6443
    bind 95.217.39.205:6443
    mode tcp
    option tcplog
    default_backend ocp4-upi-6443
backend ocp4-upi-6443
    balance source
    mode tcp
    server      bootstrap 10.84.3.2:6443 check
    server      controller-0 10.84.3.30:6443 check
    server      controller-1 10.84.3.31:6443 check
    server      controller-2 10.84.3.32:6443 check

frontend ocp4-upi-22623
    bind 95.217.39.205:22623
    mode tcp
    option tcplog
    default_backend ocp4-upi-22623
backend ocp4-upi-22623
    balance source
    mode tcp
    server      bootstrap 10.84.3.2:22623 check
    server      controller-0 10.84.3.30:22623 check
    server      controller-1 10.84.3.31:22623 check
    server      controller-2 10.84.3.32:22623 check

frontend ocp4-upi-443
    bind 95.217.39.205:443
    mode tcp
    option tcplog
    default_backend ocp4-upi-443
backend ocp4-upi-443
    balance source
    mode tcp
    server      worker-0 10.84.3.40:443 check
    server      worker-1 10.84.3.41:443 check
    server      worker-2 10.84.3.42:443 check

frontend ocp4-upi-80
    bind 95.217.39.205:80
    mode tcp
    option tcplog
    default_backend ocp4-upi-80
backend ocp4-upi-80
    balance source
    mode tcp
    server      worker-0 10.84.3.40:80 check
    server      worker-1 10.84.3.41:80 check
    server      worker-2 10.84.3.42:80 check
----

### SELinux
----
$ semanage port -l | grep http_port_t
http_port_t                    tcp      1984, 6443, 80, 81, 443, 488, 8008, 8009, 8443, 9000

$ semanage port -a -t http_port_t -p tcp 22623
----

## Deployment

----
kcli plan -f kcli.yml ocp4-upi
virsh net-dumpxml ocp4-upi.bohne.io > ocp4-upi.bohne.io.dhcp
kcli plan ocp4-upi --stop
----

Hacking DNS & DHCP config because of https://github.com/karmab/kcli/issues/140[KCLI Issue 140]

   virsh net-edit ocp4-upi.bohne.io

.Network XML -  ocp4-upi.bohne.io
[source,xml]
----
<network>
  <name>ocp4-upi.bohne.io</name>
  <uuid>0b6e406c-1fce-41f1-8913-9fedbd1dbf13</uuid>
  <metadata>
    <kvirt:info xmlns:kvirt="kvirt">
      <kvirt:plan>ocp4-upi</kvirt:plan>
    </kvirt:info>
  </metadata>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <bridge name='virbr2' stp='on' delay='0'/>
  <mac address='52:54:00:c1:fc:42'/>
  <domain name='ocp4-upi.bohne.io'/>
  <dns>
    <host ip='10.84.3.42'>
      <hostname>worker-2.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.41'>
      <hostname>worker-1.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.40'>
      <hostname>worker-0.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.32'>
      <hostname>controller-2.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.31'>
      <hostname>controller-1.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.30'>
      <hostname>controller-0.ocp4-upi.bohne.io</hostname>
    </host>
    <host ip='10.84.3.2'>
      <hostname>bootstrap.ocp4-upi.bohne.io</hostname>
    </host>
  </dns>
    <ip address='10.84.3.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.84.3.2' end='10.84.3.254'/>
      <host mac='52:54:00:05:88:2e' name='worker-2.ocp4-upi.bohne.io' ip='10.84.3.42'/>
      <host mac='52:54:00:e0:c1:32' name='worker-1.ocp4-upi.bohne.io' ip='10.84.3.41'/>
      <host mac='52:54:00:32:f9:28' name='worker-0.ocp4-upi.bohne.io' ip='10.84.3.40'/>
      <host mac='52:54:00:d1:91:49' name='controller-2.ocp4-upi.bohne.io' ip='10.84.3.32'/>
      <host mac='52:54:00:cd:b3:de' name='controller-1.ocp4-upi.bohne.io' ip='10.84.3.31'/>
      <host mac='52:54:00:9d:fd:c1' name='controller-0.ocp4-upi.bohne.io' ip='10.84.3.30'/>
      <host mac='52:54:00:a2:a3:5d' name='bootstrap.ocp4-upi.bohne.io' ip='10.84.3.2'/>
    </dhcp>
  </ip>
</network>
----


.Redeploy network
----
virsh net-destroy ocp4-upi.bohne.io
virsh net-start ocp4-upi.bohne.io
kcli plan ocp4-upi --start
----

.Install all nodes:
----
virsh console bootstrap.ocp4-upi.bohne.io
<TAB>
Append:
ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/bootstrap-0.ign

virsh console controller-0.ocp4-upi.bohne.io
<TAB>
Append:
ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/master-0.ign

ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/master-1.ign

ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/master-2.ign


virsh console worker-0.ocp4-upi.bohne.io
<TAB>
Append:
ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/worker-0.ign

ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/worker-1.ign

ip=dhcp console=tty0 console=ttyS0 coreos.inst.install_dev=vda  coreos.inst.image_url=http://ds.bohne.io/ocp4/rhcos-410.8.20190509.3-metal-bios.raw.gz coreos.inst.ignition_url=http://ds.bohne.io/ocp4/worker-2.ign


----





## Hackspace

----
# Static ip stuff
# Don't use `--slurpfile` because of https://github.com/stedolan/jq/issues/1908

cat bootstrap.ign | jq ".storage.files |= . + $(./static-ip.sh bootstrap.ocp4-upi.bohne.io 10.84.3.2)"  -c > /var/www/html/ocp4/bootstrap-static-ip.ign


----
